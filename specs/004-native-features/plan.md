# Implementation Plan - Native Integration (Notification & Sensory Feedback)

**Feature Branch**: `004-native-features`
**Spec**: [specs/004-native-features/spec.md](../spec.md)

## Technical Context

**Scope**:
- Add Android Foreground Service to keep timer alive.
- Add Notification support (persistent).
- Add Sensory feedback (Haptics + Audio).
- Strict permission handling (Android 13+).

**Architecture**:
- **Core**: `INativeFocusService` interface.
- **Platform (Android)**: `AndroidFocusService` (Impl), `FocusSessionService` (Native Service).
- **UI/VM**: Integrate into `FocusViewModel`.

**Constraints**:
- **NO TIMER in Notification**: The notification is static text or just "Stay Focused". Updating it every second is battery intensive and not requested explicitly (Spec says "Content: Stay focused!").
- **No Crash**: Permission denial must be handled gracefully.

## Constitution Check

- [x] **Library-First**: N/A (Feature integration).
- [x] **Test-First**: Unit tests for ViewModel logic calling the service; Manual/Integration tests for Service lifecycle (hard to unit test native services).
- [x] **Simplicity**: Using raw `MediaPlayer` and standard `Service` instead of heavy packages.

## Phase 1: Infrastructure & Assets

- [ ] **Asset Setup**:
  - Verify `Success_Bell.mp3` exists.
  - Move to `Resources/Raw/Success_Bell.mp3`.
  - Set Build Action to `MauiAsset`.
- [ ] **Core Interface**:
  - Define `INativeFocusService` in `SingleTask.Core`.
  - Add `StartSession`, `StopSession`, `PlaySuccessSoundAsync`, `TriggerHapticFeedback`.
  - Add Permission methods.
- [ ] **Manifest Update**:
  - Add `FOREGROUND_SERVICE` permission.
  - Add `POST_NOTIFICATIONS` permission.
  - Register Service in Manifest (if not auto-generated by attribute).

## Phase 2: Android Implementation

- [ ] **Service Implementation (`FocusSessionService`)**:
  - Inherit `Service`.
  - Implement `OnStartCommand`.
  - Implement Notification Channel creation.
  - Implement `StartForeground`.
- [ ] **Bridge Implementation (`AndroidFocusService`)**:
  - Implement `INativeFocusService`.
  - `StartSession`: Create Intent -> `StartForegroundService`.
  - `StopSession`: Create Intent -> `StopService`.
  - `PlaySuccessSoundAsync`: Use `Android.Media.MediaPlayer`.
  - `TriggerHapticFeedback`: Use `Maui.Devices.HapticFeedback`.
- [ ] **Dependency Injection**:
  - Register in `MauiProgram.cs` under `#if ANDROID`.

## Phase 3: Integration & Logic

- [ ] **ViewModel Integration (`FocusViewModel`)**:
  - Inject `INativeFocusService`.
  - `StartFocus`: Call `StartSession` + Haptics.
  - `StopFocus` (Complete/Cancel): Call `StopSession` + Haptics.
  - `CompleteTask`: Call `PlaySuccessSoundAsync` + Haptics.
- [ ] **Permission Logic**:
  - In `StartFocus`, check `CheckNotificationPermissionAsync`.
  - If missing, `RequestNotificationPermissionAsync`.
  - If denied, **DO NOT** call `StartSession` (Service requires notification). Log warning.

## Phase 4: Testing & Polish

- [ ] **Unit Tests**:
  - Mock `INativeFocusService`.
  - Verify ViewModel calls `StartSession` on start.
  - Verify ViewModel calls `StopSession` on stop.
  - Verify ViewModel calls `PlaySuccessSoundAsync` on completion.
- [ ] **Manual Verification**:
  - **Test A**: Permissions Granted -> Notification appears, persists, app backgrounds safely.
  - **Test B**: Permissions Denied -> No crash, no notification.
  - **Test C**: Audio plays on task complete.
